{% load custom_filters %}

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Flux des utilisateurs suivis</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f8f8f8; padding: 20px; }
        .card { background: #fff; border: 1px solid #ccc; margin-bottom: 20px; padding: 15px; border-radius: 8px; }
        .response { margin-left: 20px; padding: 5px 0; }
        .form-block { margin-top: 10px; }
    </style>
</head>
<body>

<h1 style="color: green;">✅ Flux chargé</h1>

{% if items %}
    {% for item in items %}
        <div class="card">
            {% if item.feed_type == "review" %}
                <h3>📝 Critique par {{ item.user.username }}</h3>
                {% if item.title %}
                    <p><strong>Titre :</strong> {{ item.title }}</p>
                {% endif %}
                <p><strong>Note :</strong> {{ item.rating }}/5</p>
                <p>{{ item.content }}</p>
                <small>Posté le {{ item.created_at|date:"d M Y, H:i" }}</small>

                <h4>💬 Réponses :</h4>
                {% for response in item.responses.all %}
                    <div class="response">
                        <strong>{{ response.responder.username }}</strong> : {{ response.content }}
                    </div>
                {% empty %}
                    <p>Aucune réponse pour cette critique.</p>
                {% endfor %}

                {% if user.is_authenticated %}
                    <div class="form-block">
                        <form method="post">
                            {% csrf_token %}
                            <input type="hidden" name="review_id" value="{{ item.id }}">
                            {{ form.as_p }}
                            <button type="submit">Répondre</button>
                        </form>
                    </div>
                {% endif %}

            {% elif item.feed_type == "ticket" %}
                <h3>🎟️ Ticket créé par {{ item.user.username }}</h3>
                <p><strong>Titre :</strong> {{ item.title }}</p>
                <p>{{ item.description }}</p>
                <small>Créé le {{ item.created_at|date:"d M Y, H:i" }}</small>

            {% elif item.feed_type == "response" %}
                <h3>💬 Réponse postée par {{ item.responder.username }}</h3>
                <p>{{ item.content }}</p>
                <p><em>Sur la critique de {{ item.review.user.username }}</em></p>
                <small>Répondu le {{ item.created_at|date:"d M Y, H:i" }}</small>

            {% else %}
                <p>Type inconnu.</p>
            {% endif %}
        </div>
    {% endfor %}
{% else %}
    <p>Aucun élément dans le flux.</p>
{% endif %}

</body>
</html>
